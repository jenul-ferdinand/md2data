name: Release

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to release (e.g., 0.1.0)'
        required: true
        type: string

env:
  CARGO_TERM_COLOR: always

permissions:
  contents: write
  packages: write
  id-token: write

jobs:
  # -----------------------------------------------------------------
  # 1. PREPARE & CREATE RELEASE
  # -----------------------------------------------------------------
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    outputs:
      upload_url: ${{ steps.create_release.outputs.upload_url }}
      version: ${{ steps.get_version.outputs.version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: get_version
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Get tag message
        id: tag_msg
        if: github.event_name == 'push' && startsWith(github.ref, 'refs/tags/')
        run: |
          # Extract the tag subject (the -m message)
          # %(contents:subject) grabs the first line of the annotation
          TAG_MSG=$(git tag -l --format='%(contents:subject)' ${{ github.ref_name }})
          
          # Handle empty messages safely
          if [ -n "$TAG_MSG" ]; then
            echo "msg=$TAG_MSG" >> $GITHUB_OUTPUT
            echo "Found tag message: $TAG_MSG"
          else
            echo "msg=" >> $GITHUB_OUTPUT
            echo "No tag message found"
          fi

      - name: Verify version consistency
        run: |
          TAG_VERSION="${{ steps.get_version.outputs.version }}"

          # Check Rust crate version
          CARGO_VERSION=$(grep "^version" crates/md2data/Cargo.toml | head -n 1 | awk -F '"' '{print $2}')
          if [ "$TAG_VERSION" != "$CARGO_VERSION" ]; then
            echo "::error::Tag version $TAG_VERSION does not match Cargo.toml version $CARGO_VERSION"
            exit 1
          fi

          # Check Python package version
          PYTHON_VERSION=$(grep "^version" bindings/python/pyproject.toml | head -n 1 | awk -F '"' '{print $2}')
          if [ "$TAG_VERSION" != "$PYTHON_VERSION" ]; then
            echo "::error::Tag version $TAG_VERSION does not match pyproject.toml version $PYTHON_VERSION"
            exit 1
          fi

          # Check Node package version
          NODE_VERSION=$(grep '"version"' bindings/node/package.json | head -n 1 | awk -F '"' '{print $4}')
          if [ "$TAG_VERSION" != "$NODE_VERSION" ]; then
            echo "::error::Tag version $TAG_VERSION does not match package.json version $NODE_VERSION"
            exit 1
          fi

          echo "âœ… All package versions match tag version: $TAG_VERSION"

      - name: Generate changelog
        id: changelog
        shell: bash
        run: |
          PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          if [ -z "$PREV_TAG" ]; then
            raw_log=$(git log --pretty=format:"- %s (%h)" --no-merges)
          else
            raw_log=$(git log ${PREV_TAG}..HEAD --pretty=format:"- %s (%h)" --no-merges)
          fi
          # Filter out chore/merge/ci commits for cleaner log
          CLEAN_LOG=$(echo "$raw_log" | grep -viE "^- (chore|merge|ci)(\([^)]+\))?:")
          
          cat > changelog.txt <<EOF
          ## What's Changed
          $CLEAN_LOG

          ## Installation
          Download the appropriate binary for your platform below:
          - **Windows**: \`md2data-${{ steps.get_version.outputs.version }}-x86_64-pc-windows-msvc.zip\`
          - **macOS (Intel)**: \`md2data-${{ steps.get_version.outputs.version }}-x86_64-apple-darwin.tar.gz\`
          - **macOS (Apple Silicon)**: \`md2data-${{ steps.get_version.outputs.version }}-aarch64-apple-darwin.tar.gz\`
          - **Linux (GNU)**: \`md2data-${{ steps.get_version.outputs.version }}-x86_64-unknown-linux-gnu.tar.gz\`
          - **Linux (musl/Alpine)**: \`md2data-${{ steps.get_version.outputs.version }}-x86_64-unknown-linux-musl.tar.gz\`

          Verify checksums with \`SHA256SUMS.txt\`.
          EOF
          
          EOF_DELIMITER=$(openssl rand -hex 8)
          echo "changelog<<$EOF_DELIMITER" >> $GITHUB_OUTPUT
          cat changelog.txt >> $GITHUB_OUTPUT
          echo "$EOF_DELIMITER" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.event_name == 'workflow_dispatch' && format('v{0}', inputs.version) || github.ref_name }}
          target_commitish: ${{ github.sha }}
          name: v${{ steps.get_version.outputs.version }}${{ steps.tag_msg.outputs.msg != '' && format(' - {0}', steps.tag_msg.outputs.msg) || '' }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: true
          prerelease: ${{ contains(steps.get_version.outputs.version, '-') }}

  # -----------------------------------------------------------------
  # 2. BUILD CLI BINARIES
  # -----------------------------------------------------------------
  build-cli:
    name: Build CLI ${{ matrix.target }}
    needs: create-release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - target: x86_64-pc-windows-msvc
            os: windows-latest
            archive: zip
          - target: x86_64-apple-darwin
            os: macos-13
            archive: tar.gz
          - target: aarch64-apple-darwin
            os: macos-latest
            archive: tar.gz
          - target: x86_64-unknown-linux-gnu
            os: ubuntu-latest
            archive: tar.gz
          - target: x86_64-unknown-linux-musl
            os: ubuntu-latest
            archive: tar.gz
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}
      - name: Cache Cargo build
        uses: Swatinem/rust-cache@v2
        with:
          key: ${{ matrix.target }}
      - name: Install musl tools (Linux musl only)
        if: matrix.target == 'x86_64-unknown-linux-musl'
        run: |
          sudo apt-get update
          sudo apt-get install -y musl-tools
      - name: Build release binary
        run: cargo build --release --all-features --target ${{ matrix.target }} --package md2data
      - name: Strip binary (Unix)
        if: matrix.os != 'windows-latest'
        run: strip target/${{ matrix.target }}/release/md2data
      - name: Create archive
        id: archive
        shell: bash
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          TARGET="${{ matrix.target }}"
          ARCHIVE_NAME="md2data-${VERSION}-${TARGET}"
          mkdir -p "${ARCHIVE_NAME}"
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            cp "target/${TARGET}/release/md2data.exe" "${ARCHIVE_NAME}/"
            7z a "${ARCHIVE_NAME}.zip" "${ARCHIVE_NAME}"
            echo "asset=${ARCHIVE_NAME}.zip" >> $GITHUB_OUTPUT
          else
            cp "target/${TARGET}/release/md2data" "${ARCHIVE_NAME}/"
            tar czf "${ARCHIVE_NAME}.tar.gz" "${ARCHIVE_NAME}"
            echo "asset=${ARCHIVE_NAME}.tar.gz" >> $GITHUB_OUTPUT
          fi
      - name: Generate checksum
        shell: bash
        run: |
          ASSET="${{ steps.archive.outputs.asset }}"
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            HASH=$(certutil -hashfile "$ASSET" SHA256 | tr -d '\r' | awk '/^[0-9A-Fa-f ]+$/ { gsub(" ",""); print; exit }')
            echo "$HASH  $ASSET" > "$ASSET.sha256"
          else
            shasum -a 256 "$ASSET" > "$ASSET.sha256"
          fi
      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          files: |
            ${{ steps.archive.outputs.asset }}
            ${{ steps.archive.outputs.asset }}.sha256

  # -----------------------------------------------------------------
  # 3. BUILD PYTHON WHEELS (Matrix)
  # -----------------------------------------------------------------
  build-pypi:
    name: Build Python Wheels (${{ matrix.target }})
    needs: create-release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux x86_64 (manylinux)
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            manylinux: 2014
          # Linux aarch64 (manylinux)
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            manylinux: 2014
          # macOS x86_64 (cross-compile on ARM)
          - os: macos-latest
            target: x86_64-apple-darwin
          # macOS ARM64 (native)
          - os: macos-latest
            target: aarch64-apple-darwin
          # Windows x86_64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
    steps:
      - uses: actions/checkout@v4
      - uses: PyO3/maturin-action@v1
        with:
          command: build
          target: ${{ matrix.target }}
          args: --release --out dist ${{ matrix.manylinux && format('--manylinux {0}', matrix.manylinux) || '' }}
          working-directory: bindings/python

      - name: Upload wheels
        uses: actions/upload-artifact@v4
        with:
          name: wheels-${{ matrix.target }}
          path: bindings/python/dist
          if-no-files-found: error

  # -----------------------------------------------------------------
  # 4. PUBLISH PYTHON TO PYPI (Atomic)
  # -----------------------------------------------------------------
  publish-pypi:
    name: Publish to PyPI
    needs: [create-release, build-pypi]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download all wheels
        uses: actions/download-artifact@v4
        with:
          pattern: wheels-*
          path: dist
          merge-multiple: true

      - name: List wheels
        run: ls -lh dist/

      - name: Publish to PyPI
        uses: PyO3/maturin-action@v1
        with:
          command: upload
          args: --non-interactive dist/*
        env:
          MATURIN_PYPI_TOKEN: ${{ secrets.PYPI_TOKEN }}

  # -----------------------------------------------------------------
  # 5. BUILD NODE BINARIES (Matrix)
  # -----------------------------------------------------------------
  build-npm:
    name: Build NPM (${{ matrix.target }})
    needs: create-release
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
          - os: windows-latest
            target: x86_64-pc-windows-msvc
          - os: macos-latest
            target: x86_64-apple-darwin
          - os: macos-latest
            target: aarch64-apple-darwin
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Dependencies
        working-directory: bindings/node
        run: npm install

      # Build with explicit target for cross-compilation support
      - name: Build
        working-directory: bindings/node
        run: npm run build -- --target ${{ matrix.target }}

      # Rename to platform-specific name for multi-platform publishing
      - name: Rename binary
        working-directory: bindings/node
        shell: bash
        run: |
          # Find the built .node file (it might be named md2data.node or index.node)
          # We ignore the node_modules folder and look for files not already named index.*.node
          NODE_FILE=$(find . -maxdepth 1 -name "*.node" ! -name "index.*.node" -print -quit)

          if [ -n "$NODE_FILE" ]; then
            echo "Found binary: $NODE_FILE"
            mv "$NODE_FILE" "index.${{ matrix.target }}.node"
            echo "Renamed to index.${{ matrix.target }}.node"
          else
            echo "::error::No .node binary found in bindings/node"
            ls -la
            exit 1
          fi

      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        with:
          name: bindings-${{ matrix.target }}
          path: bindings/node/*.node
          if-no-files-found: error

  # -----------------------------------------------------------------
  # 6. PUBLISH NPM (Single Job - Download & Publish)
  # -----------------------------------------------------------------
  publish-npm:
    name: Publish to NPM
    needs: [create-release, build-npm]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      # Prepare the package directory
      - name: Install Dependencies
        working-directory: bindings/node
        run: npm install --ignore-scripts

      # Download all artifacts from the matrix build
      - name: Download Artifacts
        uses: actions/download-artifact@v4
        with:
          path: bindings/node/artifacts
          pattern: bindings-*
          merge-multiple: true

      # Move artifacts to where npm publish expects them
      # (Adjust this move command based on your package structure!)
      - name: Move artifacts
        working-directory: bindings/node
        run: |
          ls -R artifacts
          mv artifacts/*.node .
          rm -rf artifacts
          ls -la *.node

      - name: Publish
        working-directory: bindings/node
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: npm publish --access public

  # -----------------------------------------------------------------
  # 7. PUBLISH RUST CRATE
  # -----------------------------------------------------------------
  publish-crate:
    name: Publish to Crates.io
    needs: [create-release, build-cli]
    runs-on: ubuntu-latest
    if: ${{ !contains(needs.create-release.outputs.version, '-') }}
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable

      - name: Check if version already published
        id: check
        run: |
          VERSION="${{ needs.create-release.outputs.version }}"
          CRATE_NAME="md2data"

          # Query crates.io API to check if this version exists
          RESPONSE=$(curl -s "https://crates.io/api/v1/crates/${CRATE_NAME}/${VERSION}")

          if echo "$RESPONSE" | grep -q "\"num\":\"${VERSION}\""; then
            echo "Version ${VERSION} already published, skipping"
            echo "should_publish=false" >> $GITHUB_OUTPUT
          else
            echo "Version ${VERSION} not found, will publish"
            echo "should_publish=true" >> $GITHUB_OUTPUT
          fi

      - name: Publish md2data
        if: steps.check.outputs.should_publish == 'true'
        run: |
          cd crates/md2data
          cargo publish --token ${{ secrets.CARGO_TOKEN }}

  # -----------------------------------------------------------------
  # 8. FINALIZE RELEASE (Publish Draft)
  # -----------------------------------------------------------------
  finalize-release:
    name: Finalize Release
    needs: [create-release, build-cli, publish-pypi, publish-npm, publish-crate]
    runs-on: ubuntu-latest
    if: success()
    steps:
      - uses: actions/checkout@v4

      - name: Publish Release
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: v${{ needs.create-release.outputs.version }}
          draft: false
          make_latest: true
